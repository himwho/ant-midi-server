<!doctype html>
<html>

<head>
  <title>🎛️🐜 - Aunt Colony </title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <!--

                                                      ██▓▓██
                                                    ██▓▓██        ██████████
                                                  ██▓▓██      ████▓▓▓▓▓▓▓▓▓▓██
                                                ██▓▓██      ██▓▓▒▒▒▒▒▒▓▓▓▓▓▓██
                                                ██▓▓██    ██▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓██
                                                ██▓▓██  ██▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓██
                                              ██▓▓██  ██▓▓▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓██
                                              ██▓▓██  ██▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓██
                          ██████              ██▓▓██  ██▒▒▒▒▒▒▓▓▓▓▓▓▓▓██
                  ████████▒▒▒▒▒▒████          ██▓▓████▓▓▒▒▒▒▓▓▓▓▓▓▓▓██
            ██████▓▓▓▓▓▓▓▓██████▒▒▒▒██        ██▓▓████▓▓▓▓▓▓▓▓▓▓▓▓██
            ██▓▓▓▓████████      ████▓▓██        ██████▓▓▓▓▓▓▓▓████  ██████
              ████                  ██▓▓██  ████▓▓▓▓▓▓██▓▓████  ████▒▒▒▒▓▓██████
                                      ██▓▓██▓▓▓▓▒▒▒▒▓▓▓▓██  ████▓▓▒▒██████▓▓▓▓▓▓
                      ██████            ██▓▓▒▒▒▒▒▒▓▓▓▓██████▓▓▓▓████      ██████
                  ████▒▒▒▒▒▒████      ██▓▓▒▒▒▒▒▒▓▓▓▓██▓▓▓▓▓▓████
                ██▒▒▒▒██████▒▒▒▒████  ██▒▒▒▒▒▒▓▓▓▓████████████████
              ██▒▒████      ████▓▓▓▓██▓▓▒▒▒▒▓▓████▓▓▓▓▓▓▒▒▒▒▒▒▒▒▓▓██
            ██▓▓██              ██████▓▓▒▒▓▓██▒▒██████████████████▓▓██
          ██▓▓██                    ██▓▓▓▓▓▓██▒▒██                ██▓▓██
        ██▓▓██                ████████▓▓▓▓████▒▒██                ██▓▓██
      ██▓▓██              ████▓▓▓▓▓▓▓▓████  ██▒▒██                ██▓▓██
    ██▓▓██              ██▓▓▒▒▒▒▒▒▓▓▓▓██    ██▒▒██                ██▓▓██
  ██▓▓██              ██▓▓▒▒██▒▒▒▒▓▓▓▓██    ██▓▓██                  ██▓▓██
  ████          ████████████▒▒▒▒██▓▓▓▓██    ██▓▓██                    ██▓▓████
            ████    ██▓▓▒▒▒▒▒▒██▓▓▓▓▓▓██    ██▓▓██                      ██▓▓▓▓██
          ██      ██▓▓▒▒▒▒▒▒▓▓██▓▓████      ██▓▓██                        ██████
        ██        ██▓▓▒▒▒▒▓▓▓▓▓▓██▓▓██      ██▓▓██
        ██        ██▓▓▓▓▓▓▓▓▓▓██▓▓██        ██▓▓██
      ██        ██▓▓████▓▓▓▓▓▓████  ██      ██▓▓██
    ██          ██▓▓██  ██████      ██    ██▓▓██
████            ████  ██▓▓▓▓██      ██    ██▓▓██       auntcolony.com
                    ██▓▓████      ██      ██▓▓██
                    ████          ██      ██▓▓██
                    ░░░░        ▓▓░░      ██▓▓██
                              ██░░        ██▓▓██
                            ██            ██▓▓██
                          ██              ██▓▓██
                          ██              ████
                        ██
                        ██
                        ██
                        ██
                        ██

-->
  <link rel="stylesheet" type="text/css" href="public/css/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
</head>

<body>
  <div id="app" class="left-col" style="float:left;width:33%;margin:auto;order:1;">
    <section class="section">
      <div class="container">
        <h1 class="title">🎛️ 🐜</h1>
        <div class="field is-grouped" style="margin-bottom: 20px;">
          <p class="control">
            <a class="button is-small is-info" href="/security">
              🔐 Security Dashboard
            </a>
          </p>
        </div>
        <div class="columns">
          <div class="column">
            <div class="field">
              <div class="control">
                <div class="select">
                  <select v-on:change='onOutputChange' v-model='midiOutIndex'>
                    <option value="-1">Select Output</option>
                    <option v-for='name, i in outputList' v-bind:value='i'>{{ name }}</option>
                    <option value='synth'>Web Synth</option>
                  </select>
                </div>
              </div>
              <table class="table">
                <thead>
                  <tr>
                    <th>Channel</th>
                    <th>Command</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody name="list" is="transition-group">
                  <template v-for='message in messages'>
                    <tr v-bind:key="message.id" class="list-item">
                      <td>{{ getChannel(message) }}</td>
                      <td>{{ getCommand(message) }}</td>
                      <td>{{ getNote(message) }}</td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
          <div class="column">
            <transition name="slide-fade">
              <div class="columns" v-if='midiOutIndex === "synth"'>
                <div class="column">
                  <div class="field">
                    <label class="label">Attack: {{ synthAttack }}</label>
                    <div class="control">
                      <input type="range" v-model.number='synthAttack' min="0" max="2" step=".2"
                        v-on:input="attackActive = true" v-on:mouseup="attackActive = false">
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Decay: {{ synthDecay }} </label>
                    <div class="control">
                      <input type="range" v-model.number='synthDecay' min="0" max="2" step=".2"
                        v-on:input="decayActive = true" v-on:mouseup="decayActive = false">
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Sustain: {{ synthSustain }}</label>
                    <div class="control">
                      <input type="range" v-model.number='synthSustain' min="0" max="1" step=".1"
                        v-on:input="sustainActive = true" v-on:mouseup="sustainActive = false">
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Release: {{ synthRelease }}</label>
                    <div class="control">
                      <input type="range" v-model.number='synthRelease' min="0" max="5" step=".1"
                        v-on:input="releaseActive = true" v-on:mouseup="releaseActive = false">
                    </div>
                  </div>
                  <div class="field is-grouped">
                    <button class="button is-small" v-on:mouseup="mouseUp"
                      v-on:mousedown="() => mouseDown('A2')">A</button>
                    <button class="button is-small" v-on:mouseup="mouseUp"
                      v-on:mousedown="() => mouseDown('B2')">B</button>
                    <button class="button is-small" v-on:mouseup="mouseUp"
                      v-on:mousedown="() => mouseDown('C3')">C</button>
                    <button class="button is-small" v-on:mouseup="mouseUp"
                      v-on:mousedown="() => mouseDown('D3')">D</button>
                    <button class="button is-small" v-on:mouseup="mouseUp"
                      v-on:mousedown="() => mouseDown('E3')">E</button>
                    <button class="button is-small" v-on:mouseup="mouseUp"
                      v-on:mousedown="() => mouseDown('F3')">F</button>
                    <button class="button is-small" v-on:mouseup="mouseUp"
                      v-on:mousedown="() => mouseDown('G3')">G</button>
                  </div>
                </div>
                <div class="column">
                  <pre>{{ liveAdsr }}</pre>
                </div>
              </div>
            </transition>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="right-col" style="position:relative;float:right;width:66%;margin:auto;order:2;">
    <div style="margin: 0;position: absolute;top: 50%;-ms-transform: translateY(25%);transform: translateY(25%);">
      <iframe
        src="https://player.twitch.tv/?channel=auntcolony&parent=auntcolony.com&parent=www.auntcolony.com&parent=please.nyc&parent=www.please.nyc&muted=true"
        height="720"
        width="960"
        allowfullscreen=false>
      </iframe>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.min.js"></script>
  <script>
    var socket = io();

    var app = new Vue({
      el: '#app',
      data: {
        adsr: null,
        synth: null,
        synthAttack: 1,
        synthDecay: 1,
        synthSustain: 0.5,
        synthRelease: 2,
        synthFilterFreq: 0,
        attackActive: false,
        decayActive: false,
        sustainActive: false,
        releaseActive: false,
        messages: [],
        midiOutIndex: -1,
        midiAccess: null,
        noteMap: ["E2", "F2", "F#2", "G2", "G#2", "A2", "A#2", "B2", "C3", "C#3", "D3", "D#3", "E3", "F3", "F#3", "G3", "G#3", "A3", "A#3", "B3", "C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4", "C5", "C#5", "D5", "D#5", "E5", "F5", "F#5", "G5", "G#5", "A5", "A#5", "B5", "C6", "C#6", "D6", "D#6", "E6", "F6", "F#6", "G6", "G#6", "A6", "A#6", "B6", "C7", "C#7", "D7", "D#7", "E7", "F7", "F#7", "G7", "G#7", "A7", "A#7", "B7", "C8", "C#8", "D8", "D#8", "E8", "F8", "F#8", "G8", "G#8", "A8", "A#8", "B8", "C9", "C#9", "D9", "D#9", "E9", "F9", "F#9", "G9", "G#9"],
        antCrypt: new AntCrypt(),
        currentHash: null,
        encryptedFiles: new Map()
      },
      computed: {
        inputList() {
          let inputs = [];
          if (this.midiAccess) {
            this.midiAccess.inputs.forEach(input => {
              inputs.push(input.name)
            });
          }
          return inputs;
        },
        outputList() {
          let outputs = [];
          if (this.midiAccess) {
            this.midiAccess.outputs.forEach(output => {
              outputs.push(output.name)
            });
          }
          return outputs;
        },
        midiOutput() {
          if (this.midiAccess) {
            return Array.from(this.midiAccess.outputs.values())[this.midiOutIndex];
          } else {
            return null;
          }
        },
        liveAdsr() {
          let maxHeight = 10;
          let minWidth = 20;
          let maxWidth = 40;

          let height = Math.ceil(this.synthDecay * 1.5 + this.synthAttack * 3.5);
          let width = Math.ceil((this.synthRelease * 4));

          height = height > maxHeight ? maxHeight : height;
          width = width > maxWidth ? maxWidth : width + minWidth;

          height = height > 0 ? height : 1;
          width = width > 0 ? width : 1;

          let sustHeight = Math.ceil(height * this.synthSustain);
          let sustWidth = Math.ceil((width - (sustHeight * 2)) - ((height - sustHeight) * 2));

          sustHeight = sustHeight > 1 ? sustHeight : 1;

          let rows = [];
          let paddingStart = 0;
          let paddingEnd = 0;

          for (let rowNum = 1; rowNum <= height; rowNum++) {
            let row = '';

            for (let rowPaddingStart = 0; rowPaddingStart < paddingStart; rowPaddingStart++) {
              row += ' ';
            }
            row += '/';

            let numSpaces = width - (paddingStart + paddingEnd) - 2;

            if (rowNum >= sustHeight && sustHeight > 0) {
              numSpaces -= sustWidth;
            }

            for (let rowSpaces = 1; rowSpaces <= numSpaces; rowSpaces++) {

              if (this.attackActive) {
                if (rowSpaces <= (height - rowNum)) {
                  row += 'X';
                } else {
                  row += ' ';
                }
              } else if (this.decayActive) {
                if (rowSpaces > (height - rowNum)) {
                  if (rowNum < sustHeight) {
                    if (rowSpaces < numSpaces - (sustWidth + (sustHeight - rowNum - 2))) {
                      row += 'X';
                    } else {
                      row += ' ';
                    }
                  } else {
                    row += 'X';
                  }
                } else {
                  row += ' ';
                }
              } else if (this.sustainActive) {
                if (rowNum < sustHeight && rowSpaces >= numSpaces - (sustWidth + (sustHeight - rowNum - 2)) && rowSpaces <= numSpaces - (sustHeight - rowNum - 1)) {
                  row += 'X'
                } else {
                  row += ' ';
                }
              } else if (this.releaseActive) {
                if (rowNum < sustHeight && rowSpaces > numSpaces - (sustHeight - rowNum)) {
                  row += 'X'
                } else {
                  row += ' ';
                }
              } else {
                row += ' ';
              }
            }

            row += '\\';

            if (rowNum === sustHeight) {
              for (let rowSus = 1; rowSus <= sustWidth; rowSus++) {
                row += '_';
              }
            }

            for (let rowPaddingEnd = 0; rowPaddingEnd < paddingEnd; rowPaddingEnd++) {
              row += ' ';
            }

            for (let maxWidthPadding = 0; maxWidthPadding < maxWidth - width; maxWidthPadding++) {
              row += ' ';
            }


            row += '\n'

            paddingStart++;
            paddingEnd++;

            rows.unshift(row);
          }

          if (height < maxHeight) {
            for (let headSpace = 1; headSpace <= (maxHeight - height); headSpace++) {
              rows.unshift('\n');
            }
          }

          return rows.join('');
        }
      },
      methods: {
        initMidi() {
          if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess()
              .then(this.onMIDISuccess, this.onMIDIFailure);
          } else {
            console.log('WebMIDI is not supported in this browser.');
          }
        },
        handleMIDIMessage(data) {
          if (this.synth) {
            this.synthHandleMIDIMessage(data);
          } else if (this.midiOutput) {
            const midiMessage = [data.x, data.y, data.z];
            this.midiOutput.send(midiMessage);
          }
        },
        initSocketHandler() {
          socket.on('osc', (data) => {
            data.id = this.uuidv4();
            this.handleMIDIMessage(data);
            this.messages = [data, ...this.messages.slice(0, 4)];
          });
          
          // Listen for hash updates from security system
          socket.on('hash', (hashData) => {
            this.antCrypt.updateHash(hashData.value);
            this.currentHash = {
              value: hashData.value,
              timestamp: hashData.timestamp
            };
          });
        },
        onMIDISuccess(midiAccess) {
          this.midiAccess = midiAccess;
          midiAccess.onstatechange = function (e) {
            // Print information about the (dis)connected MIDI controller
            console.log(e.port.name, e.port.manufacturer, e.port.state);
          };
        },
        onMIDIFailure() {
          console.log('Could not access your MIDI devices.');
        },
        onOutputChange(e) {
          if (e.target.value === 'synth') {
            this.initSynth();
          } else {
            this.synth = null;
          }
        },
        getChannel(data) {
          var noteChannel;
          if (data.x < 144 && data.x >= 128) {
            noteChannel = (data.x - 128) + 1;
          } else if (data.x >= 144) {
            noteChannel = (data.x - 144) + 1;
          }
          return noteChannel;
        },
        getCommand(data) {
          var command;
          if (data.x < 144 && data.x >= 128) {
            command = "Note Off";
          } else if (data.x >= 144) {
            command = "Note On";
          }
          return command
        },
        getNote(data) {
          return this.noteMap[data.y - 40];
        },
        midiToString(data) {
          var note = this.noteMap[data.y - 40];
          var noteType, noteChannel;
          if (data.x < 144 && data.x >= 128) {
            noteType = "OFF";
            noteChannel = (data.x - 128) + 1;
          } else if (data.x >= 144) {
            noteType = "ON";
            noteChannel = (data.x - 144) + 1;
          }
          return `Channel: ${noteChannel} Command: ${noteType} Note: ${note}`;
        },
        uuidv4() {
          // https://stackoverflow.com/a/2117523
          return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
          );
        },
        async initSynth() {
          await Tone.start()
          this.synth = new Tone.MonoSynth({
            oscillator: {
              type: "square"
            },
            envelope: {
              attack: this.synthAttack,
              decay: this.synthDecay,
              sustain: this.synthSustain,
              release: this.synthRelease,
            }
          }).toDestination();
        },
        mouseDown(note) {
          const now = Tone.now()
          this.synth.triggerAttack(note, now);
        },
        mouseUp() {
          const now = Tone.now()
          this.synth.triggerRelease(now);
        },
        synthHandleMIDIMessage(data) {
          const note = this.getNote(data)
          const now = Tone.now()
          if (data.x < 144 && data.x >= 128) {
            this.synth.triggerRelease(now);
          } else if (data.x >= 144) {
            this.synth.triggerAttack(note, now);
          }
        },
        async handleFileEncryption(file) {
          try {
            const result = await this.antCrypt.encryptFile(file);
            
            // Generate download
            const url = URL.createObjectURL(result.file);
            const a = document.createElement('a');
            a.href = url;
            a.download = `encrypted_${file.name}`;
            
            // Add timestamp to filename
            const timestamp = new Date(result.timestamp).toISOString();
            a.download = `encrypted_${timestamp}_${file.name}`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Encryption failed:', error);
            alert('Encryption failed: ' + error.message);
          }
        },

        async handleFileDecryption(file) {
          try {
            // Extract timestamp from filename
            const match = file.name.match(/encrypted_(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)/);
            if (!match) {
              throw new Error('Invalid encrypted file name - missing timestamp');
            }
            const timestamp = new Date(match[1]).getTime();

            const decryptedFile = await this.antCrypt.decryptFile(file, timestamp);
            
            // Generate download
            const url = URL.createObjectURL(decryptedFile);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name.replace(/encrypted_\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z_/, 'decrypted_');
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Decryption failed:', error);
            alert('Decryption failed: ' + error.message);
          }
        }
      },
      created() {
        this.initMidi();
        this.initSocketHandler();
      },
      watch: {
        synthAttack() {
          this.synth.envelope.attack = this.synthAttack;
        },
        synthDecay() {
          this.synth.envelope.decay = this.synthDecay;
        },
        synthSustain() {
          this.synth.envelope.sustain = this.synthSustain;
        },
        synthRelease() {
          this.synth.envelope.release = this.synthRelease;
        },
      },
      mounted() {
        // Setup file encryption handlers
        document.getElementById('fileToEncrypt').addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            document.getElementById('encryptFileName').textContent = file.name;
            document.getElementById('encryptButton').disabled = false;
          }
        });

        document.getElementById('encryptButton').addEventListener('click', () => {
          const file = document.getElementById('fileToEncrypt').files[0];
          if (file) {
            this.handleFileEncryption(file);
          }
        });

        document.getElementById('fileToDecrypt').addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            document.getElementById('decryptFileName').textContent = file.name;
            document.getElementById('decryptButton').disabled = false;
          }
        });

        document.getElementById('decryptButton').addEventListener('click', () => {
          const file = document.getElementById('fileToDecrypt').files[0];
          if (file) {
            this.handleFileDecryption(file);
          }
        });
      }
    })
  </script>

</body>

</html>
